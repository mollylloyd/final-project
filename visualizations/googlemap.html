<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
    <script type="text/javascript"  src="http://d3js.org/d3.v3.min.js"></script>
	<script src="http://d3js.org/queue.v1.min.js"></script>
	<link rel="stylesheet" href="style.css" media="all" />

  </head>
  <body>
  <div class="g-graphic">
	<button id="g-play-button">Pause</button>
  </div>
    <div id="map"></div>
    <script type="text/javascript">

// Create the Google Map…
var map = new google.maps.Map(d3.select("#map").node(), {
  zoom: 5,
  //Center on Earthquake Epicenter
  center: new google.maps.LatLng(36.605814, 141.729368),
  mapTypeId: google.maps.MapTypeId.ROADMAP
});

var googleProjection,
    quakePadding = 200,
	wavePadding = 20,
	earthquakesLayer,
	tsunamiLayer;

//Use queue() to load data and avoid asynchronous problems
function loadData() {
	queue()
		.defer(d3.json, 'earthquakes_short.json') // Get the Earthquake Data
		.defer(d3.csv, 'waveHeightShort.csv') // Get the Tsunami Data
		.defer(d3.json, 'earthquakes_short.json') // Get the Radiation Data
		.await(createVis); // function to create
}



// Load the quakes data. When the data comes back, create an overlay.
function createVis(error,earthquake_data,tsunami_data,radiation_data){
  var overlay = new google.maps.OverlayView();

  // Add the container when the overlay is added to the map.
  overlay.onAdd = function() {
    earthquakesLayer = d3.select(this.getPanes().overlayLayer).append("div")
        .attr("class", "quakes");
		
	tsunamiLayer = d3.select(this.getPanes().overlayLayer).append("div")
        .attr("class", "waves");

    overlay.draw = function() {
	    googleProjection = this.getProjection();
		//Add Earthquakes
		addEarthquakes(earthquake_data);

		//Add Tsunami
		addTsunami(tsunami_data);

		//Add Radiation
		addRadiation(radiation_data);
    };
  };
  overlay.setMap(map);
}




function transformQuake(d) {
	d = new google.maps.LatLng(d.value.geometry.coordinates[1], d.value.geometry.coordinates[0]);
	d = googleProjection.fromLatLngToDivPixel(d);
	return d3.select(this)
		.style("left", (d.x - quakePadding) + "px")
		.style("top", (d.y - quakePadding) + "px");
}

function transformWave(d) {
//console.log(d);
	d = new google.maps.LatLng(d.value.Latitude, d.value.Longitude);
	d = googleProjection.fromLatLngToDivPixel(d);
	return d3.select(this)
		.style("left", (d.x - wavePadding) + "px")
		.style("top", (d.y - wavePadding) + "px");
}

//Add Earthquakes 
function addEarthquakes(data){

		var marker = earthquakesLayer.selectAll("svg")
			.data(d3.entries(data.features))
			.each(transformQuake) // update existing markers
			.enter().append("svg:svg")
			.each(transformQuake)
			.attr("class", "marker");

      // Adds a label to each marker
		marker.append("svg:text")
			.attr("x", 17)
			.attr("y", 10)
			.attr("dy", ".2em")
			.text(function(d) { return d.value.properties.mag; });

	  //add rings
		marker.append("circle")
			.attr("class", "quake-circle")
			.attr("r", 2);

		setInterval(function() {
		  marker.append("circle")
			  .attr("class", "ring")
			  .attr("r", 3)
			  .style("stroke-width", 1.5)
			  .style("stroke", "red")
			  .transition()
			  .ease("linear")
			  .duration(6000)
			  .style("stroke-opacity", 1e-6)
			  .style("stroke-width", 1)
			  .style("stroke", "brown")
			  .attr("r", map.getZoom() *5)
			  .remove();
		}, 750);
}


function addTsunami(data){
		var waves = tsunamiLayer.selectAll("svg")
			.data(d3.entries(data))
			.each(transformWave) // update existing markers
			.enter().append("svg:svg")
			.each(transformWave)
			.attr("class", "wave");
			
		waves.append("circle")
			.attr("class", "wave-circle")
			.attr("r", 1);
}

function addRadiation(data){
console.log(data);
//TODO add vis
}

loadData();
    </script>
  </body>
</html>