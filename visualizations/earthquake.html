<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
    <script type="text/javascript" src="http://d3js.org/d3.v3.min.js"></script>
    <script type="text/javascript" src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,600,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="style.css" media="all"/>
</head>
<body>
<div id="map"></div>

<script type="text/javascript">
// Create the Google Map
var map = new google.maps.Map(d3.select("#map").node(), {
    zoom: 6,
    //Center on Earthquake Epicenter
    center: new google.maps.LatLng(39, 142.5),
    mapTypeControl: false,
    zoomControl: false,
    draggable: false,
    scrollwheel: false,
    disableDoubleClickZoom: true,
    mapTypeId: google.maps.MapTypeId.ROADMAP,
    disableDefaultUI: true
});

var googleProjection,
    quakePadding = 200,
    earthquakesLayer,
	dataLength,
	timeMarker;

var currentDate = new Date();
var startDate = new Date();
var endDate = new Date();

var speed = 7200;

//begin basemap styles
var styles = [
    {
        stylers: [
            { hue: "#0099CC" },
            { saturation: -50}
        ]
    },
    {
        featureType: "road",
        elementType: "geometry",
        stylers: [
            { lightness: 100 },
            { visibility: "off" }
        ]
    },
    {
        featureType: "road",
        elementType: "labels",
        stylers: [
            { visibility: "off" }
        ]
    },
    {
        featureType: "landscape",
        elementType: "all",
        stylers: [
            {visibility: "on"},
            {color: "#CCCCCC"},
            {saturation: -50}
        ]
    },
    {
        featureType: "administrative.locality",
        elementType: "labels",
        stylers: [
            {visibility: "off"}
        ]
    },
    {
        featureType: "administrative.province",
        elementType: "geometry.stroke",
        stylers: [
            {visibility: "off"}
        ]
    },
    {
        featureType: "administrative.province",
        elementType: "geometry",
        stylers: [
            {hue: "#0D0D0D"},
            {saturation: 100}
        ]
    }
];
//end map styles

//addDays date function
Date.prototype.addDays = function(days)
{
    var dat = new Date(this.valueOf());
    dat.setDate(dat.getDate() + days);
    return dat;
}

//Quake Color
var quakeColor = d3.scale.linear()
    .domain([5, 60])
    .range(["#FF3300", "#800000"])
    .interpolate(d3.interpolateLab);

//apply map styles to the map
map.setOptions({styles: styles});

// Load the quakes data. When the data comes back, create an overlay.
d3.json("../data/earthquakes.json", function (error, earthquake_data) {
    var overlay = new google.maps.OverlayView();

	//set the min and max dates
	sortedData = earthquake_data.features;
	sortedData.sort(function(a, b){return a.properties.time - b.properties.time;})
	startDate = new Date(sortedData[0].properties.time);
	dataLength = sortedData.length;
	endDate = new Date(sortedData[dataLength-1].properties.time);

    // Add the container when the overlay is added to the map.
    overlay.onAdd = function () {
        earthquakesLayer = d3.select(overlay.getPanes().overlayLayer).append("div")
            .attr("class", "quakes");
			addEarthquakes(sortedData);
        overlay.draw = function () {
            googleProjection = overlay.getProjection();
        };
    };
    overlay.setMap(map);
});

// Earthquakes

function addEarthquakes(data) {

    quakes = earthquakesLayer.attr("class", "quakes");
	var transition = d3.transition()
		.duration(500)
		.ease("linear");
	
	var legendHtml = "<h3>Legend</h3><br><div class='legendBox' style='opacity:1;'></div><div class='legendLabel'></div><br><div class='legendBox' style='opacity:.84;'></div><div class='legendLabel'></div><br><div class='legendBox' style='opacity:.67;'></div><div class='legendLabel'></div><br><div class='legendBox' style='opacity:.5;'></div><div class='legendLabel'></div><br><div class='legendBox' style='opacity:.33;'></div><div class='legendLabel'></div>";
	
	var earthquakeLegend = earthquakesLayer.append("div")
        .attr("class", "legend");
	
	earthquakeLegend.html(legendHtml);
	
	var timeout = 0;
	var i = 1;
	var circle;

	

	
	function dataLoop () {     
	   setTimeout(function () {
		    timeout = (data[i+1].properties.time - data[i].properties.time)/speed
		    //console.log(i+" date = "+new Date(data[i].properties.time).toUTCString()+"  timeout = "+timeout+" mag = "+data[i].properties.mag+" depth = "+data[i].geometry.coordinates[2]);

			d = new google.maps.LatLng(data[i].geometry.coordinates[1], data[i].geometry.coordinates[0]);
			d = googleProjection.fromLatLngToDivPixel(d);

			//add circles
			quake = earthquakesLayer.append("svg")
				.attr("class", "quake")
				.style("left", (d.x - quakePadding) + "px")
				.style("top", (d.y - quakePadding) + "px");
				
				
			circle = quake.append("circle")
				.attr("class", "quake-circle")
				.attr("r", 4)
				.style("fill", function (d) {
					return quakeColor(data[i].geometry.coordinates[2])
				})
				.transition()
			     .duration(2500)
				  .attr("r", Math.pow(1.7,data[i].properties.mag))
				  .style("opacity", .1)
				  .remove();
			


			
			rings = quake.append("circle")
			    .attr("class", "ring")
				.attr("r", 2)
				.style("stroke-width", .5)
				.style("stroke", function (d) {
					return quakeColor(data[i].geometry.coordinates[2])
				})
				.transition()
				  .ease("linear")
				  .duration(1500)
				  .style("stroke-opacity", 0.00001)
				  .style("stroke-width", 1)
				  .attr("r",Math.pow(2,data[i].properties.mag))
				  .remove();
				  
			//add a bar to the chart  

		    barSvg.append("rect")
		      .attr("class", "bar")
			  .attr("id", i)
			  .attr("x", x(new Date(data[i].properties.time)) )
			  .attr("width", 1)
			  .on("click", function(d){d3.selectAll("rect").remove(); dataLoop(this.id);}) 
			  .attr("y", function(d) { return y(data[i].properties.mag); })
			  .attr("height", function(d) { return height - y(data[i].properties.mag); });
				  
			timeMarker.attr("cx", x(new Date(data[i].properties.time)))
				 .transition()
				  .ease("linear")
				  .duration(timeout)
				  .attr("cx", x(new Date(data[i+1].properties.time)))  
				  

		  i++;
		  if (i < data.length -1) { 
			 dataLoop();
		  }
	   }, timeout)
	}
	

	
	
	

	
	
	//chart
	
	var margin = {top: 20, right: 20, bottom: 30, left: 40},
    width = 900 - margin.left - margin.right,
    height = 100 - margin.top - margin.bottom;

	
	
var x = d3.time.scale()
		.domain([startDate, endDate])
		.range([0, width]);

var y = d3.scale.linear()
        .domain([0,10])
        .range([height, 0]);

var xAxis = d3.svg.axis()
    .scale(x)
    .orient("bottom")
	.tickFormat(d3.time.format("%b %d %x"));

	

var yAxis = d3.svg.axis()
    .scale(y)
    .orient("left")
    .ticks(5);

var barSvg = d3.select("body").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
	.append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");


  barSvg.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis);

  barSvg.append("g")
      .attr("class", "y axis")
      .call(yAxis)
    .append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", -30)
      .attr("dy", ".71em")
      .style("text-anchor", "end")
      .text("Magnitude");

	
	//console.log(x(endDate.getTime()));// - x(startDate.getTime()));
	
	timeMarker = barSvg.append("circle")
	.attr("r",3)
	.attr("cy", 50)
	.attr("class", "quake-circle");



	//Start the animation
	dataLoop(1); 

	
}
</script>
</body>
</html>
